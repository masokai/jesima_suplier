<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>مدیریت تأمین‌کنندگان پت‌شاپ</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet"/>
<style>
    * { 
      box-sizing: border-box; 
      font-family: Vazir, sans-serif; 
      margin: 0; 
      padding: 0;
    }
    
    body {
      background: #f5f5f5;
      padding: 20px;
      color: #333;
      direction: rtl;
      transition: background 0.3s, color 0.3s;
    }
    
    body.dark {
      background: #1e1e1e;
      color: #f0f0f0;
    }
    
    .form-container {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .dark .form-container {
      background: #2c2c2c;
    }
    
    h1 { 
      text-align: center; 
      margin: 5px 0 10px;
      font-size: 1.3rem;
    }
    
    h2, h3 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .header-sticky {
      position: sticky;
      top: 0;
      background: white;
      z-index: 100;
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .dark .header-sticky {
      background: #2c2c2c;
    }
    
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: inherit;
      color: inherit;
    }
    
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    button:hover { 
      background: #2980b9; 
    }
    
    .small-btn {
      padding: 5px 10px;
      font-size: 0.9em;
      width: auto;
      display: inline-block;
    }
    
    .tabs {
      display: flex;
      margin: 10px 0;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 8px 12px;
      cursor: pointer;
      background: #ecf0f1;
      margin-left: 5px;
      border-radius: 5px 5px 0 0;
      display: flex;
      align-items: center;
      gap: 5px;
      color: #333;
      font-size: 0.9rem;
    }
    
    .tab.active { 
      background: #3498db; 
      color: white !important; 
    }
    
    .tab[data-tab="cache"] { 
      background: #f39c12; 
    }
    
    .tab[data-tab="cache"].active { 
      background: #d35400; 
      color: white !important; 
    }
    
    .tab-content { 
      display: none; 
      padding-top: 10px; 
    }
    
    .tab-content.active { 
      display: block; 
    }
    
    .products-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .products-table th, 
    .products-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    
    .checkbox-large {
      transform: scale(1.5);
      margin: 0 auto;
      display: block;
    }
    
    .divider {
      border-top: 2px dashed #ccc;
      margin: 15px 0;
    }
    
    #addToBasket {
      background: #27ae60;
    }
    
    #addToBasket:hover {
      background: #219653;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      display: none;
      z-index: 10000;
    }
    
    .toast.error {
      background: #e74c3c;
    }
    
    .loader {
      position: fixed;
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 1.5rem;
    }
    
    .loader.active { 
      display: flex; 
    }

    .theme-switch {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    
    .theme-toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .theme-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .theme-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .theme-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .theme-slider {
      background-color: #2196F3;
    }
    
    input:checked + .theme-slider:before {
      transform: translateX(30px);
    }
    
    .theme-icons {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .basket-section {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    
    .dark .basket-section {
      background: #333;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .action-buttons button {
      flex: 1;
    }
    
    .search-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .search-container input {
      flex: 1;
    }
    
    .search-container button {
      width: auto;
      padding: 10px 15px;
    }
    
    .scrollable-content {
      max-height: calc(100vh - 250px);
      overflow-y: auto;
      padding: 5px;
    }
  
    select option {
      color: #000 !important;
    }

    @media (max-width: 768px) {
      .tabs {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
      }
      .tab {
        flex: 1 1 45%;
        min-width: 120px;
        text-align: center;
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
</style>
</head>
<body>
<div class="loader" id="loader">
<div>
<span class="material-icons" style="font-size: 3rem; animation: spin 1s linear infinite;">autorenew</span>
<h2>در حال پردازش...</h2>
</div>
</div>
<div class="toast" id="toast">عملیات موفقیت‌آمیز بود</div>
<div class="form-container">
<div class="header-sticky">
<div class="theme-switch">
<div class="theme-icons">
<span class="material-icons">light_mode</span>
<label class="theme-toggle">
<input id="darkToggle" type="checkbox"/>
<span class="theme-slider"></span>
</label>
<span class="material-icons">dark_mode</span>
</div>
</div>
<h1>مدیریت تأمین‌کنندگان پت‌شاپ</h1>
<div class="tabs">
<div class="tab active" data-tab="select"><span class="material-icons">person_add</span> ثبت تأمین‌کننده</div>
<div class="tab" data-tab="add"><span class="material-icons">add_box</span> افزودن محصول</div>
<div class="tab" data-tab="update"><span class="material-icons">sync</span> آپدیت نرخ</div>
<div class="tab" data-tab="cache"><span class="material-icons">cached</span> کش محصولات</div>
</div>
</div>

<!-- تب ثبت تأمین‌کننده -->
<div class="tab-content active" id="selectTab">
<div class="scrollable-content">
<input id="supplierName" placeholder="نام تأمین‌کننده"/>
<input id="supplierPhone" placeholder="شماره موبایل">
<select id="supplierProvince">
<option value="">انتخاب استان</option>
<option>تهران</option>
<option>خراسان رضوی</option>
<option>اصفهان</option>
</select>
<input id="supplierCity" placeholder="شهر"/>
<div class="divider"></div>
<div class="action-buttons">
<button id="submitSupplier"><span class="material-icons">check_circle</span> ثبت نهایی تأمین‌کننده</button>
</div>
<div class="basket-section">
<h3>سبد محصولات</h3>
<table class="products-table" id="basketTable" style="display:none;">
<thead>
<tr>
<th>نام</th>
<th>برند</th>
<th>حیوان</th>
<th>قیمت</th>
<th>سود (%)</th>
<th>حذف</th>
</tr>
</thead>
<tbody id="basketBody"></tbody>
</table>
<p id="emptyBasket">سبد محصولات خالی است</p>
</div>
<div class="divider"></div>
<h3>جستجوی محصولات</h3>
<div class="search-container">
<input id="productSearch" placeholder="جستجوی نام محصول..."/>
<input id="brandSearch" placeholder="جستجوی برند..."/>
<button class="small-btn" id="searchProductsBtn"><span class="material-icons">search</span> جستجو</button>
</div>
<button id="addToBasket"><span class="material-icons">add_shopping_cart</span> افزودن به سبد</button>
<table class="products-table">
<thead>
<tr>
<th>انتخاب</th>
<th>نام</th>
<th>برند</th>
<th>نوع حیوان</th>
<th style="width:150px;">قیمت</th>
<th style="width:120px;">سود (%)</th>
</tr>
</thead>
<tbody id="productResults">
<tr>
<td colspan="6">لطفاً ابتدا جستجو کنید</td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- تب افزودن محصول -->
<div class="tab-content" id="addTab">
<div class="scrollable-content">
<input id="newProductName" placeholder="نام محصول"/>
<input id="newProductBrand" placeholder="برند"/>
<select id="newProductAnimal">
<option value="">نوع حیوان</option>
<option>سگ</option>
<option>گربه</option>
<option>جوندگان</option>
<option>پرندگان</option>
<option>خزندگان</option>
<option>آبزیان</option>
</select>
<select id="newProductCategory">
<option value="">دسته‌بندی</option>
<option>تشویقی</option>
<option>غذای خشک</option>
<option>غذا</option>
<option>مکمل</option>
<option>لوازم جانبی</option>
<option>بهداشتی</option>
</select>
<button id="addProduct"><span class="material-icons">save</span> ثبت محصول</button>
<div id="productMessage" style="margin-top:10px;"></div>
</div>
</div>

<!-- تب آپدیت نرخ -->
<div class="tab-content" id="updateTab">
<div class="scrollable-content">
<input id="searchName" placeholder="نام تأمین‌کننده"/>
<input id="searchBrand" placeholder="برند محصول"/>
<input id="searchProduct" placeholder="نام محصول"/>
<button id="updateSearch"><span class="material-icons">search</span> جستجو</button>
<table class="products-table">
<thead>
<tr>
<th>نام تأمین‌کننده</th>
<th>محصول</th>
<th>برند</th>
<th>قیمت فعلی</th>
<th>سود فعلی</th>
<th>قیمت جدید</th>
<th>سود جدید</th>
<th>عملیات</th>
</tr>
</thead>
<tbody id="updateResults">
<tr>
<td colspan="8">برای نمایش نتایج جستجو کنید</td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- تب کش محصولات -->
<div class="tab-content" id="cacheTab">
<div class="scrollable-content">
<h2>مدیریت کش محصولات</h2>
<p>تعداد محصولات در کش: <span id="cacheCount">0</span></p>
<p>آخرین بروزرسانی: <span id="lastUpdate">هرگز</span></p>
<button id="refreshCache"><span class="material-icons">refresh</span> بروزرسانی کش</button>
<button id="clearCache"><span class="material-icons">delete</span> پاک کردن کش</button>
<table class="products-table">
<thead>
<tr>
<th>نام محصول</th>
<th>برند</th>
<th>نوع حیوان</th>
<th>دسته‌بندی</th>
</tr>
</thead>
<tbody id="productCacheBody">
<tr>
<td colspan="4">داده‌ای وجود ندارد</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<script>
  // متغیرهای عمومی
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZiwwiJn5oV9UqSgyaXCUOenDUEQu2g6meTo0UHz-d2fMppwKvtEodr2cCZMz0kriy/exec';
  let allProducts = [];
  let basket = [];
  
  // عناصر DOM
  const loader = document.getElementById('loader');
  const toast = document.getElementById('toast');
  
  // --- توابع عمومی ---
  function showLoader() {
    loader.classList.add('active');
  }
  
  function hideLoader() {
    loader.classList.remove('active');
  }
  
  function showToast(message, isSuccess = true) {
    toast.textContent = message;
    toast.className = isSuccess ? 'toast' : 'toast error';
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 3000);
  }
  
  function updateBasketUI() {
    const basketTable = document.getElementById('basketTable');
    const basketBody = document.getElementById('basketBody');
    const emptyBasket = document.getElementById('emptyBasket');
    
    basketBody.innerHTML = '';
    
    if (basket.length === 0) {
      basketTable.style.display = 'none';
      emptyBasket.style.display = 'block';
      return;
    }
    
    emptyBasket.style.display = 'none';
    basketTable.style.display = '';
    
    basket.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.brand}</td>
        <td>${item.animal}</td>
        <td>${item.price}</td>
        <td>${item.profit}</td>
        <td><button onclick="removeFromBasket(${index})" class="material-icons" style="border:none;background:none;color:red;cursor:pointer;">delete</button></td>
      `;
      basketBody.appendChild(row);
    });
  }
  
  // --- مدیریت تب‌ها ---
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab, .tab-content').forEach(item => {
        item.classList.remove('active');
      });
      
      tab.classList.add('active');
      document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
      
      // اگر تب کش فعال شد، داده‌ها را بارگذاری کن
      if (tab.dataset.tab === 'cache') {
        loadProductsToCache();
      }
    });
  });
  
  // --- حالت شب ---
  document.getElementById('darkToggle').addEventListener('change', function() {
    document.body.classList.toggle('dark', this.checked);
    localStorage.setItem('darkMode', this.checked);
  });
  
  // بارگذاری حالت شب از localStorage
  if (localStorage.getItem('darkMode') === 'true') {
    document.getElementById('darkToggle').checked = true;
    document.body.classList.add('dark');
  }
  
  // --- مدیریت کش محصولات ---
  async function loadProductsToCache() {
    showLoader();
    try {
      // ابتدا از localStorage بارگذاری می‌کنیم
      if (localStorage.getItem('productsCache')) {
        allProducts = JSON.parse(localStorage.getItem('productsCache'));
        document.getElementById('cacheCount').textContent = allProducts.length;
        document.getElementById('lastUpdate').textContent = new Date(localStorage.getItem('lastCacheUpdate') || new Date()).toLocaleString('fa-IR');
        
        updateCacheTable();
      }
      
      // سپس از سرور درخواست می‌دهیم
      const response = await fetch(`${WEB_APP_URL}?action=getProducts`);
      const serverProducts = await response.json();
      
      if (Array.isArray(serverProducts)) {
        allProducts = serverProducts;
        localStorage.setItem('productsCache', JSON.stringify(allProducts));
        localStorage.setItem('lastCacheUpdate', new Date().toISOString());
        
        document.getElementById('cacheCount').textContent = allProducts.length;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('fa-IR');
        
        updateCacheTable();
        showToast('کش محصولات با موفقیت بروزرسانی شد');
      }
      
      return true;
    } catch (error) {
      console.error('خطا در بارگذاری کش:', error);
      if (allProducts.length === 0) {
        showToast('خطا در دریافت داده از سرور. از داده‌های محلی استفاده می‌شود', false);
      }
      return false;
    } finally {
      hideLoader();
    }
  }
  
  function updateCacheTable() {
    const tbody = document.getElementById('productCacheBody');
    tbody.innerHTML = '';
    
    if (allProducts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">محصولی یافت نشد</td></tr>';
      return;
    }
    
    allProducts.forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${product[0] || '-'}</td>
        <td>${product[1] || '-'}</td>
        <td>${product[2] || '-'}</td>
        <td>${product[3] || '-'}</td>
      `;
      tbody.appendChild(row);
    });
  }
  
  document.getElementById('refreshCache').addEventListener('click', loadProductsToCache);
  
  document.getElementById('clearCache').addEventListener('click', () => {
    allProducts = [];
    localStorage.removeItem('productsCache');
    localStorage.removeItem('lastCacheUpdate');
    document.getElementById('productCacheBody').innerHTML = '<tr><td colspan="4">داده‌ای وجود ندارد</td></tr>';
    document.getElementById('cacheCount').textContent = '0';
    document.getElementById('lastUpdate').textContent = 'هرگز';
    showToast('کش محصولات پاک شد');
  });
  
  // --- جستجوی محصولات ---
  function filterProducts() {
    const productQuery = document.getElementById('productSearch').value.trim().toLowerCase();
    const brandQuery = document.getElementById('brandSearch').value.trim().toLowerCase();
    
    if (allProducts.length === 0) {
      showToast('لطفاً ابتدا کش محصولات را بارگذاری کنید', false);
      return;
    }
    
    const filtered = allProducts.filter(product => {
      const productName = (product[0] || '').toString().toLowerCase();
      const productBrand = (product[1] || '').toString().toLowerCase();
      
      const matchesProduct = productQuery ? productName.includes(productQuery) : true;
      const matchesBrand = brandQuery ? productBrand.includes(brandQuery) : true;
      
      return matchesProduct && matchesBrand;
    });
    
    const tbody = document.getElementById('productResults');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6">محصولی یافت نشد</td></tr>';
      return;
    }
    
    filtered.forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="checkbox" class="checkbox-large"></td>
        <td>${product[0] || '-'}</td>
        <td>${product[1] || '-'}</td>
        <td>${product[2] || '-'}</td>
        <td><input type="number" placeholder="قیمت" class="price-input"></td>
        <td><input type="number" placeholder="سود" class="profit-input"></td>
      `;
      tbody.appendChild(row);
    });
  }
  
  document.getElementById('searchProductsBtn').addEventListener('click', filterProducts);
  
  // --- مدیریت سبد محصولات ---
  document.getElementById('addToBasket').addEventListener('click', () => {
    if (allProducts.length === 0) {
      showToast('لطفاً ابتدا کش محصولات را بارگذاری کنید', false);
      return;
    }
    
    const rows = document.querySelectorAll('#productResults tr');
    let addedCount = 0;
    let hasError = false;
    
    rows.forEach(row => {
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox && checkbox.checked) {
        const cells = row.querySelectorAll('td');
        const priceInput = row.querySelector('.price-input');
        const profitInput = row.querySelector('.profit-input');
        
        if (!priceInput.value || !profitInput.value) {
          hasError = true;
          return;
        }
        
        basket.push({
          name: cells[1].textContent,
          brand: cells[2].textContent,
          animal: cells[3].textContent,
          price: priceInput.value,
          profit: profitInput.value
        });
        
        addedCount++;
        checkbox.checked = false;
        priceInput.value = '';
        profitInput.value = '';
      }
    });
    
    if (hasError) {
      showToast('لطفاً قیمت و سود را برای تمام محصولات انتخاب شده وارد کنید', false);
      return;
    }
    
    if (addedCount > 0) {
      updateBasketUI();
      showToast(`${addedCount} محصول به سبد اضافه شد`);
    } else {
      showToast('هیچ محصولی انتخاب نشده است', false);
    }
  });
  
  window.removeFromBasket = function(index) {
    basket.splice(index, 1);
    updateBasketUI();
    showToast('محصول از سبد حذف شد');
  };
  
  // --- ثبت تأمین‌کننده ---
  document.getElementById('submitSupplier').addEventListener('click', async () => {
    const name = document.getElementById('supplierName').value.trim();
    const phone = document.getElementById('supplierPhone').value.trim();
    const province = document.getElementById('supplierProvince').value;
    const city = document.getElementById('supplierCity').value.trim();
    
    if (!name || !phone || !province || !city) {
      showToast('لطفاً اطلاعات تأمین‌کننده را کامل کنید', false);
      return;
    }
    
    if (basket.length === 0) {
      showToast('سبد محصولات خالی است', false);
      return;
    }
    
    showLoader();
    
    try {
      for (const item of basket) {
        const data = {
          action: 'addSupplier',
          name,
          phone,
          province,
          city,
          productName: item.name,
          brand: item.brand,
          animal: item.animal,
          price: item.price,
          profitPercent: item.profit
        };
        
        const response = await fetch(`${WEB_APP_URL}?${new URLSearchParams(data)}`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'خطا در ثبت اطلاعات');
        }
      }
      
      // پاک کردن فرم و سبد پس از ثبت موفق
      document.getElementById('supplierName').value = '';
      document.getElementById('supplierPhone').value = '';
      document.getElementById('supplierProvince').value = '';
      document.getElementById('supplierCity').value = '';
      
      basket = [];
      updateBasketUI();
      
      showToast('اطلاعات تأمین‌کننده با موفقیت ثبت شد');
    } catch (error) {
      showToast('خطا در ثبت اطلاعات: ' + error.message, false);
    } finally {
      hideLoader();
    }
  });
  
  // --- افزودن محصول جدید ---
  document.getElementById('addProduct').addEventListener('click', async () => {
    const name = document.getElementById('newProductName').value.trim();
    const brand = document.getElementById('newProductBrand').value.trim();
    const animal = document.getElementById('newProductAnimal').value;
    const category = document.getElementById('newProductCategory').value;
    
    if (!name || !brand || !animal || !category) {
      showToast('لطفاً تمام فیلدهای ضروری را پر کنید', false);
      return;
    }
    
    showLoader();
    
    try {
      const data = {
        action: 'addProduct',
        name,
        brand,
        animal,
        category
      };
      
      const response = await fetch(`${WEB_APP_URL}?${new URLSearchParams(data)}`);
      const result = await response.json();
      
      if (result.success) {
        showToast('محصول با موفقیت اضافه شد');
        document.getElementById('newProductName').value = '';
        document.getElementById('newProductBrand').value = '';
        document.getElementById('newProductAnimal').value = '';
        document.getElementById('newProductCategory').value = '';
        
        // بروزرسانی کش
        await loadProductsToCache();
      } else {
        throw new Error(result.error || 'خطا در ثبت محصول');
      }
    } catch (error) {
      showToast('خطا در افزودن محصول: ' + error.message, false);
    } finally {
      hideLoader();
    }
  });
  
  // --- بروزرسانی نرخ‌ها ---
  document.getElementById('updateSearch').addEventListener('click', async () => {
    const name = document.getElementById('searchName').value.trim();
    const brand = document.getElementById('searchBrand').value.trim();
    const product = document.getElementById('searchProduct').value.trim();
    
    if (!name && !brand && !product) {
      showToast('حداقل یک فیلد جستجو را پر کنید', false);
      return;
    }
    
    showLoader();
    
    try {
      const response = await fetch(`${WEB_APP_URL}?action=searchForUpdate&name=${encodeURIComponent(name)}&brand=${encodeURIComponent(brand)}&product=${encodeURIComponent(product)}`);
      const data = await response.json();
      
      const tbody = document.getElementById('updateResults');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">موردی یافت نشد</td></tr>';
        return;
      }
      
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item[0]}</td>
          <td>${item[4]}</td>
          <td>${item[5]}</td>
          <td>${item[7]}</td>
          <td>${item[8]}%</td>
          <td><input type="number" id="newPrice${index}" placeholder="قیمت جدید"></td>
          <td><input type="number" id="newProfit${index}" placeholder="سود جدید"></td>
          <td><button onclick="updateSupplierRate(${index}, '${item[0]}', '${item[4]}', '${item[5]}')" class="material-icons" style="border:none;background:none;color:#3498db;cursor:pointer;">save</button></td>
        `;
        tbody.appendChild(row);
      });
    } catch (error) {
      showToast('خطا در جستجو: ' + error.message, false);
    } finally {
      hideLoader();
    }
  });
  
  window.updateSupplierRate = async function(index, name, product, brand) {
    const newPrice = document.getElementById(`newPrice${index}`).value;
    const newProfit = document.getElementById(`newProfit${index}`).value;
    
    if (!newPrice || !newProfit) {
      showToast('لطفاً قیمت و سود جدید را وارد کنید', false);
      return;
    }
    
    showLoader();
    
    try {
      const response = await fetch(`${WEB_APP_URL}?action=updateRate&name=${encodeURIComponent(name)}&product=${encodeURIComponent(product)}&brand=${encodeURIComponent(brand)}&price=${newPrice}&profit=${newProfit}`);
      const result = await response.json();
      
      if (result.success) {
        showToast('نرخ با موفقیت به‌روز شد');
        document.getElementById('updateSearch').click(); // Refresh results
      } else {
        throw new Error(result.error || 'خطا در به‌روزرسانی');
      }
    } catch (error) {
      showToast('خطا در به‌روزرسانی: ' + error.message, false);
    } finally {
      hideLoader();
    }
  };
  
  // بارگذاری اولیه
  document.addEventListener('DOMContentLoaded', async () => {
    // بارگذاری کش
    await loadProductsToCache();
    
    // فعال کردن تب اول
    document.querySelector('[data-tab="select"]').click();
  });
</script>
</body>
</html>
